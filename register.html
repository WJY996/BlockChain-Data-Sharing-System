<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>用户注册</title>

    <link rel="stylesheet" type="text/css" href="main.css">

    <script src="js/web3.min.js"></script>
    <script src="js/controlAbi.js"></script>
    <script src="js/control.js"></script>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

</head>
<body>
    <div class="container">

        <h1>数据共享系统</h1>

        <label for="username" class="col-lg-2 control-label">
        用户名
        </label>
        <input id="username" type="text">

        <label for="pwd1" class="col-lg-2 control-label">
        密码
        </label>
        <input id="pwd1" type="password">

        <label for="pwd2" class="col-lg-2 control-label">
        确认密码
        </label>
        <input id="pwd2" type="password">

        <label for="address" class="col-lg-2 control-label">
        账户地址
        </label>
        <input id="address" type="text">

        <button id="register">注册</button>
        <button id="login">返回登录页</button>

    </div>

    <p id="result"></p>


    <script>
    	
        /*function getLength() {
            return controlContract.methods.getUserLength().call({from: '0x60b91300d54f7F44C41F5b0dD7B40FeAfAa2581b'}, function(error, result) {
                if(!error)
                {
                    console.log(result);
                }
                else console.log(error);
            });
        }
        getLength();
*/
        function createNewUser(name,pwd,address) {
            let userAccount = address;

            controlContract.methods.isExitUserName(name, 0).call({from: userAccount}, function(error1, result1) {
                if(!error1) {
                    console.log(result1);
                    controlContract.methods.isExitUserAddress(address, 0).call({from: userAccount}, function(error2, result2) {
                    if(!error2) {
                        console.log(result2);
                        if(!result1)
                        {
                            if(!result2)
                            {
                                console.log(name);
                                $("#result").html("正在区块链上创建新用户...");
                                controlContract.methods.createUser(name,pwd,address).send({from: userAccount, gas:1000000})
                                .on("receipt", function (receipt) {
                                $("#result").html("成功创建" + name + "!");
                                })
                                .on("error", function (error) {                 
                                console.log(error);
                                });
                            }
                            else 
                            {
                                $("#result").html("用户地址已存在");
                                console.log("地址重复")
                            }
                        }
                        else 
                        {
                            $("#result").html("用户名已存在");
                            console.log("用户名重复")
                        }
                    }
                    else {
                        console.log(error2);
                    }
                    })
                }
                else {
                    console.log(error1);
                }
                    
            })
            
        }

        
        $("#register").click(function() {
            console.log($("#username").val());
            if(!isEmpty($("#username").val()) && !isEmpty($("#pwd1").val()) && !isEmpty($("#pwd2").val()) && !isEmpty($("#address").val())) {
                if($("#pwd1").val() == $("#pwd2").val()) {
                    createNewUser($("#username").val(), $("#pwd1").val(), $("#address").val());
                }
                else alert("请确认密码！");
            }
            else alert("输入内容不能为空");
        });

        $("#login").click(function() {
            window.location.href = "login.html";
        });

        setWeb3();
        controlContract.events.NewUser(function(error,event) {
            if(!error)
            {
                console.log(event); // same results as the optional callback above
                //$("#result").text("成功在链上发布！");
                alert("成功在链上发布！");
            }
            else console.log(error);
        })

        

    </script>

</body>
</html>
